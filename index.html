<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Uniquely Seen</title>
<style>
*{box-sizing:border-box;margin:0;padding:0}
body{background:#f5f2ed;font-family:'Georgia',serif;color:#1a2340;min-height:100vh;font-size:16px}
input,textarea,select,button{font-family:'Inter',system-ui,sans-serif;font-size:15px}
button{cursor:pointer;border:none;transition:all .2s}
textarea{resize:none}
::-webkit-scrollbar{width:4px}::-webkit-scrollbar-track{background:#f5f2ed}::-webkit-scrollbar-thumb{background:#d4cfc8;border-radius:2px}
.sec{background:#fff;border-radius:4px;padding:21px 23px;border:1px solid #e8e4de}
.sec-title{font-family:'Inter',system-ui,sans-serif;font-size:11px;font-weight:700;color:#999;text-transform:uppercase;letter-spacing:2px;margin-bottom:14px}
.pill{padding:8px 14px;background:#f5f2ed;border-radius:3px;font-size:13px;color:#555;line-height:1.5;font-family:'Inter',system-ui,sans-serif;border-left:2px solid #ef5223}
.inp{width:100%;background:#fff;border:1px solid #e0dbd4;border-radius:4px;color:#1a2340;font-size:15px;padding:10px 14px;outline:none;font-family:'Inter',system-ui,sans-serif}
.inp:focus{border-color:#ef5223}
.primary-btn{padding:13px 26px;border-radius:3px;background:#ef5223;color:#fff;font-size:15px;font-weight:600;border:none;font-family:'Inter',system-ui,sans-serif;letter-spacing:.3px}
.primary-btn:hover{background:#d4461a}
.primary-btn:disabled{background:#e0dbd4;color:#aaa;cursor:default}
.ctx-btn{padding:7px 16px;border-radius:30px;font-size:12px;cursor:pointer;transition:all .2s;font-family:'Inter',system-ui,sans-serif;font-weight:500;letter-spacing:.3px}
.qcard{background:#fff;border-radius:4px;padding:18px 21px;border:1px solid #e8e4de;transition:border-color .2s}
.qcard:hover{border-color:#ef522344}
.trust-good{font-size:13px;color:#16803d;padding:4px 0;font-family:'Inter',system-ui,sans-serif}
.trust-bad{font-size:13px;color:#c0392b;padding:4px 0;font-family:'Inter',system-ui,sans-serif}
.mic-btn{display:inline-flex;align-items:center;gap:8px;padding:10px 18px;border-radius:3px;border:1.5px solid #e0dbd4;background:#fff;color:#888;font-weight:600;font-family:'Inter',system-ui,sans-serif;font-size:14px}
.mic-btn.active{border-color:#ef5223;background:#fff8f6;color:#ef5223}
.mic-pulse{width:10px;height:10px;border-radius:50%;flex-shrink:0;transition:all .3s}
.mic-pulse.live{background:#ef5223;animation:pulse 1.2s infinite}
.mic-pulse.off{background:#d4cfc8}
@keyframes pulse{0%{box-shadow:0 0 0 0 rgba(239,82,35,.5)}70%{box-shadow:0 0 0 8px rgba(239,82,35,0)}100%{box-shadow:0 0 0 0 rgba(239,82,35,0)}}
.modal-overlay{position:fixed;inset:0;background:rgba(26,35,64,.45);z-index:1000;display:flex;align-items:center;justify-content:center;padding:20px}
.modal{background:#fff;border-radius:6px;max-width:580px;width:100%;max-height:90vh;overflow-y:auto;box-shadow:0 20px 60px rgba(26,35,64,.2)}
.modal-header{padding:26px 30px 0;display:flex;align-items:flex-start;justify-content:space-between}
.modal-body{padding:20px 30px 30px}
.step{display:flex;gap:16px;padding:14px 0;border-bottom:1px solid #f5f2ed}
.step:last-child{border-bottom:none}
.step-num{width:30px;height:30px;border-radius:50%;background:#ef5223;color:#fff;font-size:14px;font-weight:700;display:flex;align-items:center;justify-content:center;flex-shrink:0;font-family:'Inter',system-ui,sans-serif;margin-top:2px}
.step-title{font-size:15px;font-weight:700;color:#1a2340;font-family:'Inter',system-ui,sans-serif;margin-bottom:4px}
.step-desc{font-size:13px;color:#888;font-family:'Inter',system-ui,sans-serif;line-height:1.6}
.tab-card{background:#f5f2ed;border-radius:4px;padding:12px 16px;margin-bottom:8px}
.tab-card-title{font-size:14px;font-weight:700;color:#1a2340;font-family:'Inter',system-ui,sans-serif;margin-bottom:3px}
.tab-card-desc{font-size:12px;color:#888;font-family:'Inter',system-ui,sans-serif;line-height:1.5}
</style>
</head>
<body>
<div id="app">

<div id="helpModal" class="modal-overlay" style="display:none" onclick="if(event.target===this)closeHelp()">
  <div class="modal">
    <div class="modal-header">
      <div>
        <div style="font-size:22px;font-weight:700;color:#1a2340;font-family:'Georgia',serif">How to Use Uniquely Seen</div>
        <div style="font-size:13px;color:#aaa;font-family:'Inter',system-ui,sans-serif;margin-top:4px">Your live communication coach for every call</div>
      </div>
      <button onclick="closeHelp()" style="background:none;font-size:26px;color:#ccc;line-height:1;padding:0;margin-left:16px">&times;</button>
    </div>
    <div class="modal-body">
      <div style="background:#f5f2ed;border-radius:4px;padding:16px 18px;margin-bottom:20px;border-left:3px solid #ef5223">
        <div style="font-size:15px;font-weight:700;color:#1a2340;font-family:'Georgia',serif;margin-bottom:8px">What this tool is for</div>
        <div style="font-size:13px;color:#555;font-family:'Inter',system-ui,sans-serif;line-height:1.8">Uniquely Seen helps you attune ‚Äî to notice and name what matters most to the person in front of you. The best communicators catch what others miss: the pause, the word chosen carefully, the thing almost said.</div>
      </div>
      <div style="font-size:11px;font-weight:700;color:#aaa;text-transform:uppercase;letter-spacing:2px;font-family:'Inter',system-ui,sans-serif;margin-bottom:4px">Get Started in 3 Steps</div>
      <div class="step"><div class="step-num">1</div><div><div class="step-title">Pick your call type</div><div class="step-desc">Choose Sales Call, Interview, Client Call, Vendor Call, or Networking at the top of the Listen tab.</div></div></div>
      <div class="step"><div class="step-num">2</div><div><div class="step-title">Open it next to your Zoom call</div><div class="step-desc">Keep this app in a side window. Zoom on the left, this on the right works great.</div></div></div>
      <div class="step"><div class="step-num">3</div><div><div class="step-title">Capture what they say, then generate</div><div class="step-desc">Hit <strong>üéô Mic</strong> to listen. Questions auto-generate after each pause, or hit <strong>Generate Questions</strong> manually anytime.</div></div></div>
      <div style="font-size:11px;font-weight:700;color:#aaa;text-transform:uppercase;letter-spacing:2px;font-family:'Inter',system-ui,sans-serif;margin:20px 0 10px">What Each Tab Does</div>
      <div class="tab-card"><div class="tab-card-title">üéô Listen ‚Äî During the call</div><div class="tab-card-desc">Real-time question generator. Pick call type, link a contact for memory, star your favorites.</div></div>
      <div class="tab-card"><div class="tab-card-title">üìã Prep ‚Äî Before the call</div><div class="tab-card-desc">Get pain hypotheses, opener questions, what to listen for, and traps to avoid.</div></div>
      <div class="tab-card"><div class="tab-card-title">üìù Debrief ‚Äî After the call</div><div class="tab-card-desc">Paste notes or transcript. Get rapport score, missed moments, blind spots.</div></div>
      <div class="tab-card"><div class="tab-card-title">üë§ Contacts ‚Äî Relationship memory</div><div class="tab-card-desc">Save people with their communication style. Link them in Listen for smarter questions.</div></div>
      <div class="tab-card" style="margin-bottom:0"><div class="tab-card-title">‚≠ê Favorites ‚Äî Your best questions</div><div class="tab-card-desc">Star any question to save it here.</div></div>
      <button onclick="closeHelp()" class="primary-btn" style="width:100%;margin-top:20px;text-align:center">Got it ‚Äî let's go</button>
    </div>
  </div>
</div>

<div id="keyModal" class="modal-overlay" style="display:none">
  <div class="modal">
    <div class="modal-body" style="padding:30px">
      <div style="font-size:20px;font-weight:700;color:#1a2340;font-family:'Georgia',serif;margin-bottom:6px">Enter your Anthropic API Key</div>
      <div style="font-size:13px;color:#888;font-family:'Inter',system-ui,sans-serif;margin-bottom:20px;line-height:1.6">Your key is stored only in your browser and never shared. Get it at <a href="https://console.anthropic.com" target="_blank" style="color:#ef5223">console.anthropic.com</a></div>
      <input id="keyInput" class="inp" placeholder="sk-ant-api03-..." style="margin-bottom:12px"/>
      <button onclick="saveKey()" class="primary-btn" style="width:100%">Save & Continue</button>
    </div>
  </div>
</div>

<div style="background:#1a2340;border-bottom:1px solid #0d1525;padding:0 28px">
  <div style="max-width:680px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;padding:14px 0">
    <img src="uniquelyseen4.png" alt="Uniquely Seen" style="height:47px;object-fit:contain;mix-blend-mode:lighten"/>
    <div style="display:flex;align-items:center;gap:16px">
      <div style="display:flex;align-items:center;gap:7px">
        <div id="headerMicDot" class="mic-pulse off"></div>
        <span id="headerMicLabel" style="font-size:11px;color:rgba(255,255,255,.35);font-family:'Inter',system-ui,sans-serif;letter-spacing:.8px;text-transform:uppercase">Idle</span>
      </div>
      <button onclick="document.getElementById('keyModal').style.display='flex'" style="background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.15);border-radius:30px;color:rgba(255,255,255,.4);font-size:12px;font-family:'Inter',system-ui,sans-serif;padding:5px 12px">API Key</button>
      <button onclick="openHelp()" style="background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.2);border-radius:30px;color:#ddd;font-size:13px;font-family:'Inter',system-ui,sans-serif;font-weight:600;padding:6px 16px">How it works?</button>
    </div>
  </div>
  <div id="tabBar" style="display:flex;overflow-x:auto;max-width:680px;margin:0 auto;border-top:1px solid rgba(255,255,255,.08)"></div>
</div>

<div style="padding:22px 28px 52px;max-width:680px;margin:0 auto" id="mainContent"></div>
</div>

<script>
let API_KEY = localStorage.getItem('us-apikey') || '';

function saveKey() {
  const v = document.getElementById('keyInput').value.trim();
  if (!v.startsWith('sk-')) { alert('That doesn\'t look right ‚Äî it should start with sk-'); return; }
  API_KEY = v;
  localStorage.setItem('us-apikey', v);
  document.getElementById('keyModal').style.display = 'none';
}

function checkKey() {
  if (!API_KEY) {
    document.getElementById('keyInput').value = '';
    document.getElementById('keyModal').style.display = 'flex';
    return false;
  }
  return true;
}

let activeTab='Listen', ctx='Sales Call', transcript='', questions=[], listening=false, selContact=null;
let favorites = JSON.parse(localStorage.getItem('us-favs')||'[]');
let contacts = JSON.parse(localStorage.getItem('us-contacts')||'[]');
let history = JSON.parse(localStorage.getItem('us-hist')||'[]');
let pName='', pRole='', pCtx='Sales Call', pNotes='', pRes=null;
let dNotes='', dRes=null;
let showCF=false, editCId=null, cfN='', cfR='', cfS='', cfNt='';
let recog=null, autoGenTimer=null;

const TABS = ['Listen','Prep','Debrief','Contacts','Favorites'];
const CONTEXTS = {'Sales Call':{color:'#ef5223'},'Interview':{color:'#ef5223'},'Client Call':{color:'#ef5223'},'Vendor Call':{color:'#ef5223'},'Networking':{color:'#ef5223'}};
const TYPE_COLORS = {'Emotional':{accent:'#be185d'},'Strategic':{accent:'#ef5223'},'Deep Curious':{accent:'#1d4ed8'},'Reframe':{accent:'#15803d'},'Practical':{accent:'#b45309'}};

const CORE = `You are an elite communication and sales coach trained on:
1. "Supercommunicators" by Duhigg: match conversation type, loop for understanding, ask what/how not why.
2. "How to Know a Person" by David Brooks: Ask "What was it like?" Find the wound and the gift. Notice what lights them up.
3. "Never Split the Difference" by Voss: tactical empathy, labeling emotions, calibrated questions, mirroring.
4. WIMP Junction & Pain-Finding: Find pain beneath the stated need. Never present solutions until pain is fully felt.`;

const PREP_SYS = CORE+`\nPre-call strategist. Output ONLY valid JSON, no markdown:\n{"contextBrief":"...","painHypotheses":["..."],"whatToListenFor":["..."],"openers":[{"question":"...","type":"...","why":"..."},{"question":"...","type":"...","why":"..."},{"question":"...","type":"...","why":"..."}],"painQuestions":["...","...","..."],"watchOuts":["..."],"oneGoal":"..."}`;
const DEBRIEF_SYS = CORE+`\nPost-call coach. Output ONLY valid JSON, no markdown:\n{"rapportScore":7,"rapportNote":"...","painUncovered":"...","missedMoments":["..."],"trustBuilders":["..."],"trustBreakers":["..."],"whatTheyReallyMeant":"...","conversationTypeShifts":"...","blindSpots":["..."],"nextTimeActions":["..."],"followUpQuestions":["..."],"contactUpdates":{"style":"...","notes":"..."}}`;

function buildListenSys(c) {
  const contact = contacts.find(x => x.id === selContact);
  const mem = contact ? `\nContact: ${contact.name}, ${contact.role||''}. Style: ${contact.style||'unknown'}. Notes: ${contact.notes||'none'}.` : '';
  return CORE+mem+`\nContext: ${c}.\nGenerate 4 elite follow-up questions. Output ONLY valid JSON array, no markdown:\n[{"question":"...","type":"Emotional","why":"..."},{"question":"...","type":"Strategic","why":"..."},{"question":"...","type":"Deep Curious","why":"..."},{"question":"...","type":"Reframe","why":"..."}]`;
}

function persist() { localStorage.setItem('us-favs',JSON.stringify(favorites)); localStorage.setItem('us-contacts',JSON.stringify(contacts)); localStorage.setItem('us-hist',JSON.stringify(history)); }

async function callAI(system, userMsg) {
  if (!checkKey()) return null;
  const r = await fetch('https://api.anthropic.com/v1/messages', {
    method: 'POST',
    headers: { 'Content-Type':'application/json', 'x-api-key':API_KEY, 'anthropic-version':'2023-06-01', 'anthropic-dangerous-direct-browser-access':'true' },
    body: JSON.stringify({ model:'claude-opus-4-6', max_tokens:1400, system, messages:[{role:'user',content:userMsg}] })
  });
  const d = await r.json();
  if (d.error) throw new Error(typeof d.error==='string' ? d.error : d.error.message || JSON.stringify(d.error));
  return d.content?.[0]?.text || '';
}

function parseJ(raw) { return JSON.parse(raw.replace(/```json|```/g,'').trim()); }
function openHelp() { document.getElementById('helpModal').style.display='flex'; }
function closeHelp() { document.getElementById('helpModal').style.display='none'; }

function updateGenBtn() {
  const btn = document.getElementById('genBtn');
  if (!btn) return;
  const can = !!transcript.trim();
  btn.disabled = !can;
  btn.style.background = can ? '#ef5223' : '#f0ece6';
  btn.style.color = can ? '#fff' : '#ccc';
}

function initSpeech() {
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SR) return;
  recog = new SR();
  recog.continuous = true;
  recog.interimResults = true;
  recog.lang = 'en-US';
  let final = '';
  recog.onresult = e => {
    let interim = '';
    for (let i = e.resultIndex; i < e.results.length; i++) {
      if (e.results[i].isFinal) final += e.results[i][0].transcript + ' ';
      else interim = e.results[i][0].transcript;
    }
    transcript = final + interim;
    const ta = document.getElementById('transcriptTA');
    if (ta) ta.value = transcript;
    updateGenBtn();
    clearTimeout(autoGenTimer);
    if (transcript.trim()) autoGenTimer = setTimeout(() => { if (transcript.trim()) generate(); }, 2500);
  };
  recog.onerror = () => { listening = false; updateMicUI(); };
  recog.onend = () => { listening = false; updateMicUI(); };
}

function toggleMic() {
  if (!recog) { alert('Use Chrome for mic support.'); return; }
  if (listening) { recog.stop(); listening = false; }
  else { recog.start(); listening = true; }
  updateMicUI();
}

function updateMicUI() {
  const dot = document.getElementById('headerMicDot'), lbl = document.getElementById('headerMicLabel');
  if (dot) dot.className = listening ? 'mic-pulse live' : 'mic-pulse off';
  if (lbl) { lbl.textContent = listening ? 'Live' : 'Idle'; lbl.style.color = listening ? '#ef5223' : 'rgba(255,255,255,.35)'; }
  const btn = document.getElementById('micBtn');
  if (btn) {
    btn.className = listening ? 'mic-btn active' : 'mic-btn';
    const pd = btn.querySelector('.mic-pulse'), mt = btn.querySelector('.mic-text');
    if (pd) pd.className = listening ? 'mic-pulse live' : 'mic-pulse off';
    if (mt) mt.textContent = listening ? 'Stop' : 'Mic';
  }
}

function ctxBtns(current, fn) { return Object.entries(CONTEXTS).map(([k,v]) => { const a = current===k; return `<button class="ctx-btn" onclick="${fn}('${k}')" style="border:1.5px solid ${a?v.color:'#e0dbd4'};background:${a?v.color:'#fff'};color:${a?'#fff':'#888'}">${k}</button>`; }).join(''); }
function escQ(s) { return (s||'').replace(/\\/g,'\\\\').replace(/'/g,"\\'").replace(/"/g,'&quot;'); }

function qCard(q, idx, prefix='') {
  const st = TYPE_COLORS[q.type] || TYPE_COLORS['Practical'];
  const saved = favorites.some(f => f.question===q.question);
  return `<div class="qcard">
    <div style="display:flex;align-items:center;gap:6px;margin-bottom:10px">
      <span style="font-size:11px;font-weight:700;color:${st.accent};text-transform:uppercase;letter-spacing:1.5px;font-family:'Inter',system-ui,sans-serif">${q.type}</span>
      <div style="flex:1;height:1px;background:#f0ece6"></div>
      <button onclick="toggleFav('${prefix}',${idx})" style="background:none;font-size:16px;color:${saved?'#ef5223':'#ccc'}">${saved?'‚òÖ':'‚òÜ'}</button>
      <button onclick="copyQ('${escQ(q.question)}','${prefix+idx}')" id="cpbtn${prefix+idx}" style="background:none;font-size:12px;color:#bbb;font-family:'Inter',system-ui,sans-serif">copy</button>
    </div>
    <div style="font-size:17px;color:#1a2340;line-height:1.6;font-family:'Georgia',serif;font-style:italic">"${q.question}"</div>
    ${q.why ? `<div style="font-size:12px;color:#aaa;margin-top:10px;line-height:1.5;font-family:'Inter',system-ui,sans-serif;border-top:1px solid #f5f2ed;padding-top:10px">${q.why}</div>` : ''}
  </div>`;
}

function sec(title, inner) { return `<div class="sec"><div class="sec-title">${title}</div>${inner}</div>`; }
function pills(arr) { return `<div style="display:flex;flex-direction:column;gap:7px">${(arr||[]).map(a=>`<div class="pill">${a}</div>`).join('')}</div>`; }

function copyQ(text, idx) {
  navigator.clipboard.writeText(text);
  const btn = document.getElementById('cpbtn'+idx);
  if (btn) { btn.textContent='‚úì'; btn.style.color='#ef5223'; setTimeout(()=>{ btn.textContent='copy'; btn.style.color='#bbb'; }, 1500); }
}

function toggleFav(prefix, idx) {
  let q = prefix==='p' ? (pRes?.openers||[])[idx] : questions[idx];
  if (!q) return;
  const ex = favorites.findIndex(f => f.question===q.question);
  if (ex>=0) favorites.splice(ex,1); else favorites.push({...q, ctx, savedAt:Date.now()});
  persist(); render();
}

function setCtx(c) { ctx=c; render(); }
function setPCtx(c) { pCtx=c; render(); }

async function generate() {
  const ta = document.getElementById('transcriptTA');
  if (ta) transcript = ta.value;
  if (!transcript.trim()) return;
  const btn = document.getElementById('genBtn');
  if (btn) { btn.textContent='Thinking‚Ä¶'; btn.disabled=true; }
  try {
    const raw = await callAI(buildListenSys(ctx), `The other person just said: "${transcript.trim()}"`);
    if (!raw) return;
    questions = parseJ(raw);
    history.unshift({ctx, snippet:transcript.trim().slice(0,80), qs:questions, ts:Date.now()});
    if (history.length>10) history.pop();
    persist();
  } catch(e) { alert('Error: '+e.message); }
  render();
}

async function genPrep() {
  pName = document.getElementById('pNameI')?.value || pName;
  pRole = document.getElementById('pRoleI')?.value || pRole;
  pNotes = document.getElementById('pNotesI')?.value || pNotes;
  if (!pName.trim()) return;
  const btn = document.getElementById('prepBtn');
  if (btn) { btn.textContent='Building‚Ä¶'; btn.disabled=true; }
  try {
    const c = contacts.find(x => x.name.toLowerCase()===pName.toLowerCase());
    const mem = c ? `Known: style=${c.style}, notes=${c.notes}` : '';
    const raw = await callAI(PREP_SYS, `Person: ${pName}, Role: ${pRole}. Call: ${pCtx}. Info: ${pNotes}. ${mem}`);
    if (!raw) return;
    pRes = parseJ(raw);
  } catch(e) { alert('Error: '+e.message); }
  render();
}

async function genDebrief() {
  const ta = document.getElementById('dNotesTA');
  if (ta) dNotes = ta.value;
  if (!dNotes.trim()) return;
  const btn = document.getElementById('debriefBtn');
  if (btn) { btn.textContent='Analyzing‚Ä¶'; btn.disabled=true; }
  try {
    const raw = await callAI(DEBRIEF_SYS, `Call notes: ${dNotes}`);
    if (!raw) return;
    dRes = parseJ(raw);
    const sel = document.getElementById('dContactSel');
    const dcId = sel ? Number(sel.value) : null;
    if (dcId && dRes.contactUpdates) {
      contacts = contacts.map(c => c.id===dcId ? {...c, style:dRes.contactUpdates.style||c.style, notes:(c.notes?c.notes+' | ':'')+dRes.contactUpdates.notes, lastCall:new Date().toLocaleDateString()} : c);
      persist();
    }
  } catch(e) { alert('Error: '+e.message); }
  render();
}

function loadContactToPrep(id) { const c=contacts.find(x=>x.id===Number(id)); if(!c)return; pName=c.name; pRole=c.role||''; pNotes=c.notes||''; render(); }
function saveCF() { cfN=document.getElementById('cfNI')?.value||cfN; cfR=document.getElementById('cfRI')?.value||cfR; cfS=document.getElementById('cfSI')?.value||cfS; cfNt=document.getElementById('cfNtI')?.value||cfNt; if(!cfN.trim())return; if(editCId)contacts=contacts.map(c=>c.id===editCId?{...c,name:cfN,role:cfR,style:cfS,notes:cfNt}:c);else contacts.push({id:Date.now(),name:cfN,role:cfR,style:cfS,notes:cfNt,lastCall:null}); cfN='';cfR='';cfS='';cfNt='';showCF=false;editCId=null;persist();render(); }
function startEdit(id) { const c=contacts.find(x=>x.id===id); if(!c)return; editCId=id;cfN=c.name;cfR=c.role||'';cfS=c.style||'';cfNt=c.notes||'';showCF=true;render(); }
function deleteContact(id) { contacts=contacts.filter(c=>c.id!==id); persist(); render(); }
function deleteFavByIdx(i) { favorites.splice(i,1); persist(); render(); }
function clearFavs() { favorites=[]; persist(); render(); }
function cancelCF() { showCF=false; editCId=null; render(); }

function renderListen() {
  const contactOpts = contacts.map(c=>`<option value="${c.id}" ${selContact==c.id?'selected':''}>${c.name}</option>`).join('');
  const canGen = !!transcript.trim();
  let html = `
    <div style="display:flex;gap:7px;flex-wrap:wrap">${ctxBtns(ctx,'setCtx')}</div>
    <div style="display:flex;align-items:center;gap:12px">
      <span style="font-size:11px;color:#aaa;text-transform:uppercase;letter-spacing:1px;font-family:'Inter',system-ui,sans-serif">Contact</span>
      <select onchange="selContact=this.value||null;render()" style="background:#fff;border:1px solid #e0dbd4;border-radius:3px;color:#555;font-size:13px;padding:5px 10px;outline:none;font-family:'Inter',system-ui,sans-serif">
        <option value="">None</option>${contactOpts}
      </select>
      ${selContact ? `<span style="font-size:11px;padding:3px 10px;border-radius:2px;background:#ef522318;color:#ef5223;font-weight:600;font-family:'Inter',system-ui,sans-serif;text-transform:uppercase">Memory Active</span>` : ''}
    </div>
    <div style="background:#fff;border-radius:4px;padding:18px 20px;border:1px solid #e8e4de">
      <div style="font-size:11px;color:#aaa;margin-bottom:10px;text-transform:uppercase;letter-spacing:2px;font-family:'Inter',system-ui,sans-serif">What They're Saying</div>
      <textarea id="transcriptTA" rows="4" placeholder="Hit Mic ‚Äî or paste/type what they said." oninput="transcript=this.value;updateGenBtn()" style="width:100%;background:transparent;border:none;color:#1a2340;font-size:15px;line-height:1.7;resize:none;outline:none;font-family:'Georgia',serif">${transcript}</textarea>
      <div style="display:flex;gap:9px;margin-top:14px;padding-top:14px;border-top:1px solid #f5f2ed">
        <button id="micBtn" onclick="toggleMic()" class="${listening?'mic-btn active':'mic-btn'}">
          <div class="${listening?'mic-pulse live':'mic-pulse off'}"></div>
          <span class="mic-text">${listening?'Stop':'Mic'}</span>
        </button>
        <button onclick="transcript='';const ta=document.getElementById('transcriptTA');if(ta)ta.value='';updateGenBtn()" style="padding:10px 16px;border-radius:3px;border:1px solid #e0dbd4;background:#fff;color:#aaa;font-family:'Inter',system-ui,sans-serif;font-size:14px">Clear</button>
        <button id="genBtn" onclick="generate()" ${canGen?'':'disabled'} style="flex:1;padding:10px 0;border-radius:3px;border:none;background:${canGen?'#ef5223':'#f0ece6'};color:${canGen?'#fff':'#ccc'};font-size:15px;font-weight:600;font-family:'Inter',system-ui,sans-serif">Generate Questions</button>
      </div>
    </div>`;
  if (questions.length>0) {
    html += `<div style="font-size:11px;color:#aaa;text-transform:uppercase;letter-spacing:2px;font-family:'Inter',system-ui,sans-serif;margin-top:4px">Ask One of These</div>`;
    html += questions.map((q,i) => qCard(q,i,'')).join('');
  }
  return html;
}

function renderPrep() {
  const contactOpts = contacts.map(c=>`<option value="${c.id}">${c.name}</option>`).join('');
  let html = sec('Who Are You Meeting?', `<div style="display:flex;flex-direction:column;gap:11px">
    <input id="pNameI" class="inp" value="${pName.replace(/"/g,'&quot;')}" placeholder="Name" oninput="pName=this.value"/>
    ${contacts.length>0 ? `<select onchange="loadContactToPrep(this.value)" style="background:#fff;border:1px solid #e0dbd4;border-radius:4px;color:#888;font-size:14px;padding:10px 13px;outline:none;font-family:'Inter',system-ui,sans-serif"><option value="">Load from contacts‚Ä¶</option>${contactOpts}</select>` : ''}
    <input id="pRoleI" class="inp" value="${pRole.replace(/"/g,'&quot;')}" placeholder="Their role / company" oninput="pRole=this.value"/>
    <div style="display:flex;gap:7px;flex-wrap:wrap">${ctxBtns(pCtx,'setPCtx')}</div>
    <textarea id="pNotesI" class="inp" rows="3" placeholder="What do you know? What's your goal for this call?" oninput="pNotes=this.value">${pNotes}</textarea>
    <button id="prepBtn" class="primary-btn" onclick="genPrep()" ${!pName.trim()?'disabled':''}>Generate Prep Brief</button>
  </div>`);
  if (pRes) {
    html += sec('One Goal', `<div style="font-size:17px;color:#1a2340;line-height:1.6;font-family:'Georgia',serif">${pRes.oneGoal}</div>`);
    html += sec('Context Brief', `<div style="font-size:14px;color:#555;line-height:1.8;font-family:'Inter',system-ui,sans-serif">${pRes.contextBrief}</div>`);
    if (pRes.painHypotheses?.length) html += sec('Pain Hypotheses', pills(pRes.painHypotheses.map(p=>'‚Üí '+p)));
    html += sec('What to Listen For', pills((pRes.whatToListenFor||[]).map(w=>'‚Üí '+w)));
    html += sec('Opener Questions', `<div style="display:flex;flex-direction:column;gap:11px">${(pRes.openers||[]).map((q,i)=>qCard(q,i,'p')).join('')}</div>`);
    if (pRes.painQuestions?.length) html += sec('Pain Discovery Questions', pills(pRes.painQuestions.map(q=>'? '+q)));
    html += sec('Watch Outs', pills((pRes.watchOuts||[]).map(w=>'‚ö° '+w)));
  }
  return html;
}

function renderDebrief() {
  const contactOpts = contacts.map(c=>`<option value="${c.id}">${c.name}</option>`).join('');
  let html = sec('Call Notes / Transcript', `<div style="display:flex;flex-direction:column;gap:11px">
    <textarea id="dNotesTA" class="inp" rows="6" placeholder="Paste your call notes or a transcript‚Ä¶" oninput="dNotes=this.value">${dNotes}</textarea>
    ${contacts.length>0 ? `<div style="display:flex;align-items:center;gap:10px"><span style="font-size:11px;color:#aaa;text-transform:uppercase;letter-spacing:1px;font-family:'Inter',system-ui,sans-serif">Update Contact</span><select id="dContactSel" style="background:#fff;border:1px solid #e0dbd4;border-radius:3px;color:#888;font-size:13px;padding:5px 10px;outline:none;font-family:'Inter',system-ui,sans-serif"><option value="">None</option>${contactOpts}</select></div>` : ''}
    <button id="debriefBtn" class="primary-btn" onclick="genDebrief()" ${!dNotes.trim()?'disabled':''}>Generate Debrief</button>
  </div>`);
  if (dRes) {
    const sc=dRes.rapportScore, scCol=sc>=7?'#16803d':sc>=5?'#d97706':'#c0392b';
    html += sec('Rapport Score', `<div style="display:flex;align-items:center;gap:18px"><div style="font-size:46px;font-weight:700;color:${scCol};font-family:'Georgia',serif">${sc}<span style="font-size:20px;color:#ccc">/10</span></div><div style="font-size:14px;color:#555;line-height:1.6;font-family:'Inter',system-ui,sans-serif">${dRes.rapportNote}</div></div>`);
    if (dRes.painUncovered) html += sec('Pain Uncovered', `<div style="font-size:14px;color:#555;line-height:1.7;font-family:'Inter',system-ui,sans-serif">${dRes.painUncovered}</div>`);
    html += sec('What They Really Meant', `<div style="font-size:17px;color:#1a2340;line-height:1.7;font-family:'Georgia',serif;font-style:italic">"${dRes.whatTheyReallyMeant}"</div>`);
    html += sec('Missed Moments', pills((dRes.missedMoments||[]).map(m=>'‚Üí '+m)));
    html += sec('Trust Builders ¬∑ Trust Breakers', `<div style="display:flex;flex-direction:column;gap:6px">${(dRes.trustBuilders||[]).map(m=>`<div class="trust-good">+ ${m}</div>`).join('')}${(dRes.trustBreakers||[]).map(m=>`<div class="trust-bad">‚àí ${m}</div>`).join('')}</div>`);
    html += sec('Your Blind Spots', pills(dRes.blindSpots||[]));
    html += sec('Conversation Type Shifts', `<div style="font-size:14px;color:#555;line-height:1.7;font-family:'Inter',system-ui,sans-serif">${dRes.conversationTypeShifts}</div>`);
    html += sec('Next Time', pills((dRes.nextTimeActions||[]).map((a,i)=>`${i+1}. ${a}`)));
    html += sec('Open Next Call With', `<div style="display:flex;flex-direction:column;gap:11px">${(dRes.followUpQuestions||[]).map((q,i)=>`<div style="display:flex;align-items:flex-start;gap:9px"><span style="color:#ef5223;font-size:16px">‚Üí</span><div style="font-size:16px;color:#1a2340;line-height:1.6;font-family:'Georgia',serif;font-style:italic">${q}<button id="cpbtn_dq${i}" onclick="copyQ('${escQ(q)}','_dq${i}')" style="margin-left:10px;background:none;font-size:12px;color:#bbb;font-family:'Inter',system-ui,sans-serif;vertical-align:middle">copy</button></div></div>`).join('')}</div>`);
  }
  return html;
}

function renderContacts() {
  let html = `<div style="display:flex;align-items:center;justify-content:space-between"><div style="font-size:11px;color:#aaa;text-transform:uppercase;letter-spacing:2px;font-family:'Inter',system-ui,sans-serif">Relationship Memory</div><button onclick="showCF=true;editCId=null;cfN='';cfR='';cfS='';cfNt='';render()" class="primary-btn" style="padding:8px 18px;font-size:13px">+ Add Contact</button></div>`;
  if (showCF) html += sec(editCId?'Edit Contact':'New Contact', `<div style="display:flex;flex-direction:column;gap:11px"><input id="cfNI" class="inp" value="${cfN.replace(/"/g,'&quot;')}" placeholder="Name *"/><input id="cfRI" class="inp" value="${cfR.replace(/"/g,'&quot;')}" placeholder="Role / company"/><input id="cfSI" class="inp" value="${cfS.replace(/"/g,'&quot;')}" placeholder="Communication style"/><textarea id="cfNtI" class="inp" rows="3" placeholder="Key notes‚Ä¶">${cfNt}</textarea><div style="display:flex;gap:9px"><button class="primary-btn" onclick="saveCF()">${editCId?'Save Changes':'Save Contact'}</button><button onclick="cancelCF()" style="padding:13px 18px;border-radius:3px;border:1px solid #e0dbd4;background:#fff;color:#888;font-family:'Inter',system-ui,sans-serif;font-size:14px">Cancel</button></div></div>`);
  if (!contacts.length && !showCF) html += `<div style="padding:36px;text-align:center;color:#ccc;font-family:'Inter',system-ui,sans-serif">No contacts yet.</div>`;
  contacts.forEach(c => { html += `<div class="sec"><div style="display:flex;align-items:flex-start;justify-content:space-between"><div><div style="font-size:18px;font-weight:600;color:#1a2340;font-family:'Georgia',serif">${c.name}</div>${c.role?`<div style="font-size:13px;color:#aaa;margin-top:2px;font-family:'Inter',system-ui,sans-serif">${c.role}</div>`:''}</div><div style="display:flex;gap:12px"><button onclick="startEdit(${c.id})" style="background:none;color:#aaa;font-size:13px;font-family:'Inter',system-ui,sans-serif">Edit</button><button onclick="deleteContact(${c.id})" style="background:none;color:#ddd;font-size:18px">&times;</button></div></div>${c.style?`<div style="font-size:13px;color:#ef5223;font-family:'Inter',system-ui,sans-serif;margin-top:6px">${c.style}</div>`:''}${c.notes?`<div style="font-size:13px;color:#888;line-height:1.6;font-family:'Inter',system-ui,sans-serif;margin-top:5px">${c.notes}</div>`:''}${c.lastCall?`<div style="font-size:12px;color:#ccc;margin-top:5px;font-family:'Inter',system-ui,sans-serif">Last call: ${c.lastCall}</div>`:''}</div>`; });
  return html;
}

function renderFavorites() {
  let html = `<div style="font-size:11px;color:#aaa;text-transform:uppercase;letter-spacing:2px;font-family:'Inter',system-ui,sans-serif">Saved Questions</div>`;
  if (!favorites.length) return html + `<div style="padding:36px;text-align:center;color:#ccc;font-family:'Inter',system-ui,sans-serif">Star questions to save them here.</div>`;
  favorites.forEach((q,i) => {
    const st = TYPE_COLORS[q.type] || TYPE_COLORS['Practical'];
    const cv = CONTEXTS[q.ctx];
    html += `<div class="qcard"><div style="display:flex;align-items:center;gap:7px;margin-bottom:10px"><span style="font-size:11px;font-weight:700;color:${st.accent};text-transform:uppercase;letter-spacing:1.5px;font-family:'Inter',system-ui,sans-serif">${q.type}</span>${cv?`<span style="font-size:11px;padding:2px 9px;border-radius:2px;background:#ef522318;color:#ef5223;font-weight:600;font-family:'Inter',system-ui,sans-serif">${q.ctx}</span>`:''}<div style="flex:1;height:1px;background:#f0ece6"></div><button id="cpbtn_fv${i}" onclick="copyQ('${escQ(q.question)}','_fv${i}')" style="background:none;font-size:12px;color:#bbb;font-family:'Inter',system-ui,sans-serif">copy</button><button onclick="deleteFavByIdx(${i})" style="background:none;color:#ddd;font-size:18px">&times;</button></div><div style="font-size:17px;color:#1a2340;line-height:1.6;font-family:'Georgia',serif;font-style:italic">"${q.question}"</div>${q.why?`<div style="font-size:12px;color:#aaa;margin-top:10px;line-height:1.5;font-family:'Inter',system-ui,sans-serif;border-top:1px solid #f5f2ed;padding-top:10px">${q.why}</div>`:''}</div>`;
  });
  html += `<button onclick="clearFavs()" style="font-size:12px;color:#ccc;background:none;border:none;cursor:pointer;font-family:'Inter',system-ui,sans-serif">Clear all</button>`;
  return html;
}

function render() {
  document.getElementById('tabBar').innerHTML = TABS.map(t => {
    const badge = (t==='Favorites'&&favorites.length>0) ? ` (${favorites.length})` : (t==='Contacts'&&contacts.length>0) ? ` (${contacts.length})` : '';
    return `<button onclick="activeTab='${t}';render()" style="padding:11px 18px;background:none;border:none;border-bottom:${activeTab===t?'2.5px solid #ef5223':'2.5px solid transparent'};color:${activeTab===t?'#ef5223':'rgba(255,255,255,.45)'};font-size:14px;font-weight:${activeTab===t?700:400};white-space:nowrap;font-family:'Inter',system-ui,sans-serif">${t}${badge}</button>`;
  }).join('');
  const renderers = {Listen:renderListen, Prep:renderPrep, Debrief:renderDebrief, Contacts:renderContacts, Favorites:renderFavorites};
  document.getElementById('mainContent').innerHTML = `<div style="display:flex;flex-direction:column;gap:15px">${(renderers[activeTab]||renderListen)()}</div>`;
  updateMicUI();
  updateGenBtn();
}

initSpeech();
if (!API_KEY) setTimeout(() => document.getElementById('keyModal').style.display='flex', 300);
render();
</script>
</body>
</html>
